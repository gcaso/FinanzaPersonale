<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Allocation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* DEFINIZIONE DEL NUOVO QUADRATO COLORATO (RICHIESTA PRECEDENTE) */
        .badge-dot {
            display: inline-block;
            width: 16px;      
            height: 16px;     
            margin-right: 0.5em; /* Aumentato lo spazio per il nuovo formato */
            border-radius: 4px; /* Quadrato con bordi leggermente arrotondati */
            vertical-align: middle;
            border: 1px solid #ccc; 
        }

        /* Colori Custom Aggiornati */
        .bg-fuchsia {
            background-color: #9c27b0 !important; 
        }
        .bg-dark-green {
            background-color: #008000 !important; /* Dark Green per SWDA */
        }
        .bg-teal {
            background-color: #009688 !important; 
        }
        
        /* NUOVO COLORE PER EXUS (Pink-200) */
        .bg-pink-200 {
            background-color: #f7dded !important; 
        }
        /* NUOVO COLORE PER CSEMU (Orange-400) */
        .bg-orange-400 {
            background-color: #fb8c00 !important; 
        }
        /* NUOVO COLORE PER CSSPX (Indigo-300) */
        .bg-indigo-300 {
            background-color: #9fa8da !important; 
        }


        /* Stili della tabella e generale */
        .table-footer-total {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .chart-container {
            position: relative;
            height: 250px; 
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            margin-top: 10px;
        }
        .card-header-geo {
            background-color: #f39c12; 
            color: white;
        }
        .card-header-holdings {
            background-color: #3f51b5; 
            color: white;
        }
        .card.h-100 {
            height: 100%!important;
        }
        .disclaimer {
            font-size: 0.85rem;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
        }
        .etf-percentage-input {
            max-width: 65px; 
        }
        .input-group-sm .form-control {
            height: calc(1.5em + 0.5rem + 2px); 
            padding: 0.25rem 0.5rem;
        }
        .input-group-sm .input-group-text {
            height: calc(1.5em + 0.5rem + 2px);
            padding: 0.25rem 0.5rem;
        }
        .etf-total-percentage {
            font-weight: bold;
        }
        .holding-name {
            font-weight: 500;
        }
         .badge.bg-warning {
            text-shadow: none; 
        }
        /* Stile per rendere il link dell'indice chiaro */
        .etf-info-link {
            text-decoration: none;
            color: var(--bs-body-color, #212529); 
            font-weight: 500;
        }
        .etf-info-link:hover {
            color: var(--bs-primary, #0d6efd); 
            text-decoration: underline;
            cursor: pointer;
        }

    </style>
</head>
<body class="bg-light">

    <div id="navbar-placeholder"></div>

    <div class="container py-5">
        
        <header class="mb-5 text-center">
            <h1 class="display-5 fw-bold text-primary">Asset Allocation</h1>
            <p class="lead text-secondary">In questa pagina vengono proposti alcuni indici e l'utente è libero di allocare una percentuale di un ipotetico portafoglio azionario. L'analisi viene effettuata sui primi 10 paesi e titoli che fanno parte degli indici presenti. Lo copo è mostrare come le proprie scelte di allocazione hanno impatto sulla distribuzione geografica e azionaria del proprio capitale. Buon divertimento.</p>
        </header>

        <div class="row g-4 justify-content-center mb-4">
            
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0 fs-5">Allocazione su indici azionari</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Indice</th>
                                    <th scope="col" class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody id="etfDetailBody">
                                <tr data-etf-id="VWCE">
                                    <td><span class="badge-dot bg-danger me-2" title="FTSE All World"></span><a href="#" class="etf-info-link" data-etf-id="VWCE" title="Mostra dettagli composizione">FTSE All World</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="VWCE" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="EXUS">
                                    <td><span class="badge-dot bg-pink-200 me-2" title="MSCI World Ex USA"></span><a href="#" class="etf-info-link" data-etf-id="EXUS" title="Mostra dettagli composizione">MSCI World Ex USA</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="EXUS" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="SMEA">
                                    <td><span class="badge-dot bg-info me-2" title="MSCI Europe"></span><a href="#" class="etf-info-link" data-etf-id="SMEA" title="Mostra dettagli composizione">MSCI Europe</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="SMEA" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="AEME">
                                    <td><span class="badge-dot bg-warning me-2" title="MSCI EM"></span><a href="#" class="etf-info-link" data-etf-id="AEME" title="Mostra dettagli composizione">MSCI EM</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="AEME" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                    <td><span class="badge-dot bg-primary me-2" title="MSCI World Equal Weighted"></span><a href="#" class="etf-info-link" data-etf-id="MWEQ" title="Mostra dettagli composizione">MSCI World Equal Weighted</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="MWEQ" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="EWEQ">
                                    <td><span class="badge-dot bg-fuchsia me-2" title="MSCI Europe Equal Weight"></span><a href="#" class="etf-info-link" data-etf-id="EWEQ" title="Mostra dettagli composizione">MSCI Europe Equal Weight</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="EWEQ" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="CSSPX">
                                    <td><span class="badge-dot bg-indigo-300 me-2" title="S&P 500 (USA)"></span><a href="#" class="etf-info-link" data-etf-id="CSSPX" title="Mostra dettagli composizione">S&P 500 (USA)</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="CSSPX" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="SWDA">
                                    <td><span class="badge-dot bg-dark-green me-2" title="MSCI World"></span><a href="#" class="etf-info-link" data-etf-id="SWDA" title="Mostra dettagli composizione">MSCI World</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="SWDA" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr data-etf-id="CSEMU">
                                    <td><span class="badge-dot bg-orange-400 me-2" title="MSCI EMU (Eurozona)"></span><a href="#" class="etf-info-link" data-etf-id="CSEMU" title="Mostra dettagli composizione">MSCI EMU (Eurozona)</a></td>
                                    <td class="text-end">
                                        <div class="input-group input-group-sm justify-content-end">
                                            <input type="number" class="form-control text-end etf-percentage-input" data-etf-id="CSEMU" value="0" min="0" max="100" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="table-footer-total">
                                <tr>
                                    <td>TOTALE</td> 
                                    <td class="text-end etf-total-percentage" id="totalEtfPercentage">0.0%</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="mt-3 text-end">
<!--
                            <button class="btn btn-sm btn-info text-white me-2" id="calculateEqualWeightButton" title="Calcola la ponderazione degli indici per bilanciare l'esposizione al singolo paese">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shuffle me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.824 1.251 4.794 2.502.603.766 1.347 1.408 2.072 1.95.724.542 1.5.952 2.133 1.246 1.26.586 2.454.776 3.497.581.554-.103 1.05-.333 1.246-.487a.5.5 0 0 1 .494.81l-.004.004c-.333.256-.843.486-1.428.595-1.29.24-2.618.04-4.14-.622-1.28-.54-2.583-1.442-3.882-2.65C4.053 4.887 2.47 3.5 1 3.5H.5a.5.5 0 0 1-.5-.5z"/>
                                    <path fill-rule="evenodd" d="M12.44 6.745c.191 0 .373.064.532.192.17.135.267.319.294.516l.004.027.001.006.001.008.001.006.001.008a.5.5 0 0 1-.05.474l-.27.42c-.22.34-.51.628-.885.83-.55.297-1.183.477-1.745.54a.5.5 0 0 1-.096-.995c.504-.047 1.077-.216 1.57-.492.34-.184.613-.43.79-.69l.178-.276a.5.5 0 0 1-.04-.548.502.502 0 0 1 .374-.537l.01-.002zM12.5 13.5a.5.5 0 0 1 .5-.5h.5c2.202 0 3.824-1.251 4.794-2.502.603-.766 1.347-1.408 2.072-1.95.724-.542 1.5.952 2.133 1.246 1.26-.586 2.454-.776 3.497-.581.554.103 1.05.333 1.246.487a.5.5 0 0 1 .494-.81l-.004-.004c-.333-.256-.843-.486-1.428-.595-1.29-.24-2.618-.04-4.14.622-1.28.54-2.583 1.442-3.882 2.65C4.053 4.887 2.47 3.5 1 3.5H.5a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                                Eq. Weight Paesi
                            </button>
-->
                            <button class="btn btn-sm btn-secondary" id="resetEtfButton" title="Azzera tutte le percentuali">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2z"/>
                                    <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466"/>
                                </svg>
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0 fs-5">Top 10 Paesi (Peso Ponderato)</h4>
                    </div>
                    <div class="card-body">
                        
                        <div id="countryLegend" class="small mb-3 d-flex flex-wrap align-items-center">
                            <span class="fw-bold me-2">Legenda Colori (Indice):</span>
                            <span class="me-3"><span class="badge-dot bg-danger"></span> FTSE All World</span>
                            <span class="me-3"><span class="badge-dot bg-pink-200"></span> MSCI World Ex USA</span>
                            <span class="me-3"><span class="badge-dot bg-info"></span> MSCI Europe</span>
                            <span class="me-3"><span class="badge-dot bg-warning"></span> MSCI EM</span>
                            <span class="me-3"><span class="badge-dot bg-primary"></span> MSCI World EW</span>
                            <span class="me-3"><span class="badge-dot bg-fuchsia"></span> MSCI Europe EW</span>
                            <span class="me-3"><span class="badge-dot bg-indigo-300"></span> S&P 500 (USA)</span>
                            <span class="me-3"><span class="badge-dot bg-dark-green"></span> MSCI World</span>
                            <span class="me-3"><span class="badge-dot bg-orange-400"></span> MSCI EMU</span>
                        </div>
                        
                        <table class="table table-striped table-hover mb-0 small">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Paese</th>
                                    <th scope="col" class="text-end">Peso Ponderato %</th>
                                    <th scope="col">Indice</th> </tr>
                            </thead>
                            <tbody id="countryTableBody">
                                </tbody>
                            <tfoot class="table-footer-total">
                                <tr><td colspan="2">TOTALE TOP 10</td><td class="text-end" id="countryTotalRef"></td><td></td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="row g-4 justify-content-center">
            
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header card-header-geo text-white">
                        <h4 class="mb-0 fs-5">Esposizione Geografica Aggregata</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="geoChart"></canvas>
                        </div>
                        
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Regione</th>
                                    <th scope="col" class="text-end">Percentuale</th>
                                </tr>
                            </thead>
                            <tbody id="geoTableBody">
                                </tbody>
                            <tfoot class="table-footer-total">
                                <tr><td>TOTALE</td><td class="text-end" id="geoTotal">0.0%</td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header card-header-holdings text-white">
                        <h4 class="mb-0 fs-5">Top 10 Titoli Azionari (Peso Ponderato)</h4>
                    </div>
                    <div class="card-body">
                        
                        <div id="holdingsLegend" class="small mb-3 d-flex flex-wrap align-items-center">
                            <span class="fw-bold me-2">Legenda Colori (Indice):</span>
                            <span class="me-3"><span class="badge-dot bg-danger"></span> FTSE All World</span>
                            <span class="me-3"><span class="badge-dot bg-pink-200"></span> MSCI World Ex USA</span>
                            <span class="me-3"><span class="badge-dot bg-info"></span> MSCI Europe</span>
                            <span class="me-3"><span class="badge-dot bg-warning"></span> MSCI EM</span>
                            <span class="me-3"><span class="badge-dot bg-primary"></span> MSCI World EW</span>
                            <span class="me-3"><span class="badge-dot bg-fuchsia"></span> MSCI Europe EW</span>
                            <span class="me-3"><span class="badge-dot bg-indigo-300"></span> S&P 500 (USA)</span>
                            <span class="me-3"><span class="badge-dot bg-dark-green"></span> MSCI World</span>
                            <span class="me-3"><span class="badge-dot bg-orange-400"></span> MSCI EMU</span>
                        </div>

                        <table class="table table-striped table-hover mb-0 small">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Società</th>
                                    <th scope="col" class="text-end">Peso Ponderato %</th>
                                    <th scope="col">Indice</th> </tr>
                            </thead>
                            <tbody id="holdingsTableBody">
                                </tbody>
                            <tfoot class="table-footer-total">
                                <tr><td colspan="2">TOTALE TOP 10</td><td class="text-end" id="holdingsTotalRef"></td><td></td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <footer class="container py-4">
        <div class="disclaimer text-center">
            <p class="fw-bold text-danger">⚠️ IMPORTANTE: DISCLAIMER LEGALE</p>
            <p>I dati, i calcoli e le analisi presenti in questa pagina hanno **esclusivamente scopo informativo e didattico** e riflettono una simulazione di asset allocation. **Queste informazioni non costituiscono in alcun modo consulenza finanziaria personalizzata, raccomandazione o sollecitazione all'investimento**.</p>
            <p class="mb-0">L'investimento in strumenti finanziari comporta rischi, inclusa la perdita del capitale. Il valore di un investimento è soggetto alle fluttuazioni del mercato e può di conseguenza diminuire o aumentare. Di conseguenza, gli investitri in fondi possono perdere una parte o la totalità del loro investimento iniziale.</p>
        </div>
    </footer>


    <div class="modal fade" id="etfDetailModal" tabindex="-1" aria-labelledby="etfDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="etfDetailModalLabel">Dettagli Indice: <span id="modalIndexName"></span></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <p class="lead"><strong>Scopo dell'Indice:</strong> <span id="modalIndexPurpose"></span></p>
            
            <hr>
            
            <div class="row">
                <div class="col-lg-6">
                    <h6 class="text-primary">Top 10 Paesi (Composizione 100% Indice)</h6>
                    <table class="table table-sm table-striped small">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Paese</th>
                                <th class="text-end">% su Indice</th>
                            </tr>
                        </thead>
                        <tbody id="modalCountryBody">
                            </tbody>
                    </table>
                </div>
                <div class="col-lg-6">
                    <h6 class="text-primary">Top 10 Titoli (Composizione 100% Indice)</h6>
                    <table class="table table-sm table-striped small">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Società</th>
                                <th class="text-end">% su Indice</th>
                            </tr>
                        </thead>
                        <tbody id="modalHoldingsBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          </div>
        </div>
      </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="import.js?v1.0"></script>

    <script>
        // Variabili globali per memorizzare le istanze dei grafici
        let geoChartInstance;

        // Funzione di utility per creare/aggiornare un grafico a ciambella 
        function createDoughnutChart(ctxId, labels, data, colors) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            let instanceToUse;

            if (ctxId === 'geoChart') {
                instanceToUse = geoChartInstance;
            } 
            
            if (instanceToUse) {
                instanceToUse.destroy();
            }

            const newChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 12, padding: 10 }
                        }
                    }
                }
            });

            if (ctxId === 'geoChart') {
                geoChartInstance = newChart;
            }
            return newChart;
        }


        // --- Dati e Costanti ---

        // Colori aggiunti (mantenuti solo per il grafico Geografico)
        const geoColors = ['#e74c3c', '#3498db', '#2c3e50', '#f39c12', '#7f8c8d', '#28a745', '#4d4dff']; 
        
        // --- MAPPA CLASSI COLORI (Aggiornata con le richieste precedenti) ---
        const ETF_COLOR_MAP = {
            'VWCE': 'bg-danger text-white', 
            // AGGIORNATO
            'EXUS': 'bg-pink-200 text-dark', 
            'SMEA': 'bg-info text-white', 
            'AEME': 'bg-warning text-dark', 
            'EWEQ': 'bg-fuchsia text-white',
            'MWEQ': 'bg-primary text-white', 
            // AGGIORNATO
            'CSSPX': 'bg-indigo-300 text-dark',
            'SWDA': 'bg-dark-green text-white',
            // AGGIORNATO
            'CSEMU': 'bg-orange-400 text-white'
        };

        // Costanti per i NOMI REGIONALI
        const REGION_NAMES = {
            'NA': 'Nord America (USA)',
            'EU': 'Europa (Sviluppata)',
            'PA': 'Pacifico / Altro',
            'EM': 'Mercati Emergenti (EM)',
        };
        
        // DATI FISSI PER IL CALCOLO GEOGRAFICO (BASE 100%) - MANTENUTI PER IL GRAFICO
        const ETF_GEO_DISTRIBUTION = {
            'VWCE': { 'NA': 59.6, 'EU': 20.0, 'PA': 12.0, 'EM': 8.4 },
            'EXUS': { 'NA': 0.0, 'EU': 47.0, 'PA': 53.0, 'EM': 0.0 }, 
            'SMEA': { 'NA': 0.0, 'EU': 100.0, 'PA': 0.0, 'EM': 0.0 },
            'AEME': { 'NA': 0.0, 'EU': 0.0, 'PA': 0.0, 'EM': 100.0 },
            'MWEQ': { 'NA': 45.0, 'EU': 30.0, 'PA': 25.0, 'EM': 0.0 }, 
            'EWEQ': { 'NA': 0.0, 'EU': 100.0, 'PA': 0.0, 'EM': 0.0 },
            'CSSPX': { 'NA': 99.5, 'EU': 0.5, 'PA': 0.0, 'EM': 0.0 },
            'SWDA': { 'NA': 69.0, 'EU': 19.0, 'PA': 12.0, 'EM': 0.0 },
            'CSEMU': { 'NA': 0.0, 'EU': 100.0, 'PA': 0.0, 'EM': 0.0 }
        };

        // --- STRUTTURA DATI: INFORMAZIONI GENERALI E SCOPO ---
        const ETF_INFO_DETAIL = {
            'VWCE': { 
                index: 'FTSE All World', 
                purpose: "Azioni globali (sviluppati ed emergenti) a grande e media capitalizzazione. Offre la massima diversificazione geografica e settoriale." 
            },
            'EXUS': { 
                index: 'MSCI World Ex USA', 
                purpose: "Azioni globali sviluppate (esclusi gli USA) a grande e media capitalizzazione. Utile per diversificare l'esposizione al di fuori del mercato USA." 
            },
            'SMEA': { 
                index: 'MSCI Europe', 
                purpose: "Azioni europee sviluppate a grande e media capitalizzazione. Include Paesi dell'Eurozona e non Eurozona (es. Regno Unito, Svizzera)." 
            },
            'AEME': { 
                index: 'MSCI EM', 
                purpose: "Azioni dei mercati emergenti a grande e media capitalizzazione. Offre esposizione ad economie in rapida crescita." 
            },
            'MWEQ': { 
                index: 'MSCI World Equal Weighted', 
                purpose: "Azioni globali sviluppate con uguale peso per ogni titolo (equal weighted). Riduce la concentrazione sui titoli a maggiore capitalizzazione." 
            },
            'EWEQ': { // NUOVO AGGIUNTO
                index: 'MSCI Europe Equal Weighted', 
                purpose: "Azioni europee sviluppate con uguale peso per ogni titolo (equal weighted). Riduce la concentrazione sui titoli a maggiore capitalizzazione in Europa." 
            },
            'CSSPX': { 
                index: 'S&P 500 (USA)', 
                purpose: "Le 500 aziende statunitensi a maggiore capitalizzazione. Rappresenta l'ampio mercato azionario degli Stati Uniti." 
            },
            'SWDA': { 
                index: 'MSCI World', 
                purpose: "Azioni globali sviluppate (USA, Europa, Pacifico) a grande e media capitalizzazione. È l'indice globale standard più diffuso." 
            },
            'CSEMU': { 
                index: 'MSCI EMU (Eurozona)', 
                purpose: "Azioni dell'Unione Economica e Monetaria (Eurozona) a grande e media capitalizzazione. Focalizzato sui mercati europei che adottano l'Euro." 
            }
        };

        // --- STRUTTURE DATI DETTAGLIO ---
        const ETF_COUNTRY_DETAIL = { 
            'VWCE': [
                { name: 'Stati Uniti (USA)', weight: 62.2, code: 'USA' }, 
                { name: 'Giappone', weight: 5.6, code: 'JPN' }, 
                { name: 'Regno Unito', weight: 3.2, code: 'UK' }, 
                { name: 'Hong Kong', weight: 3.1, code: 'HKG' }, 
                { name: 'Canada', weight: 2.8, code: 'CAN' },
                { name: 'Taiwan', weight: 2.3, code: 'TAI' }, 
                { name: 'Francia', weight: 2.2, code: 'FRA' }, 
                { name: 'Germania', weight: 2.0, code: 'DEU' }, 
                { name: 'Svizzera', weight: 1.9, code: 'SWI' }, 
                { name: 'India', weight: 1.9, code: 'IND' }
            ], 
            'EXUS': [
                { name: 'Giappone', weight: 20.0, code: 'JPN' }, 
                { name: 'Regno Unito', weight: 12.0, code: 'UK' }, 
                { name: 'Canada', weight: 11.0, code: 'CAN' }, 
                { name: 'Francia', weight: 9.0, code: 'FRA' }, 
                { name: 'Svizzera', weight: 9.0, code: 'SWI' }, 
                { name: 'Germania', weight: 8.0, code: 'DEU' }, 
                { name: 'Australia', weight: 5.0, code: 'AUS' }, 
                { name: 'Paesi Bassi', weight: 5.0, code: 'NLD' }, 
                { name: 'Spagna', weight: 3.0, code: 'SPA' }, 
                { name: 'Italia', weight: 3.0, code: 'ITA' }
            ],
            'SMEA': [
                { name: 'Regno Unito', weight: 22.0, code: 'UK' }, 
                { name: 'Francia', weight: 16.0, code: 'FRA' }, 
                { name: 'Germania', weight: 15.0, code: 'DEU' }, 
                { name: 'Svizzera', weight: 14.0, code: 'SWI' }, 
                { name: 'Paesi Bassi', weight: 7.0, code: 'NLD' }, 
                { name: 'Spagna', weight: 6.0, code: 'SPA' }, 
                { name: 'Svezia', weight: 6.0, code: 'SWE' }, 
                { name: 'Italia', weight: 5.0, code: 'ITA' }, 
                { name: 'Danimarca', weight: 3.0, code: 'DEN' }, 
                { name: 'Belgio', weight: 2.0, code: 'BEL' }
            ],
            'AEME': [ 
                { name: 'Cina', weight: 28.0, code: 'CHN' }, 
                { name: 'Taiwan', weight: 20.0, code: 'TAI' }, 
                { name: 'India', weight: 16.0, code: 'IND' }, 
                { name: 'Corea del Sud', weight: 12.0, code: 'KOR' }, 
                { name: 'Brasile', weight: 5.0, code: 'BRA' }, 
                { name: 'Sudafrica', weight: 4.0, code: 'ZAF' }, 
                { name: 'Arabia Saudita', weight: 3.0, code: 'SAU' }, 
                { name: 'Messico', weight: 2.0, code: 'MEX' }, 
                { name: 'Emirati Arabi Uniti', weight: 1.0, code: 'UAE' }, 
                { name: 'Indonesia', weight: 1.0, code: 'IDN' }
            ],
            'MWEQ': [ 
                { name: 'Stati Uniti (USA)', weight: 37.38, code: 'USA' }, 
                { name: 'Giappone', weight: 13.63, code: 'JPN' }, 
                { name: 'Canada', weight: 5.88, code: 'CAN' }, 
                { name: 'Regno Unito', weight: 5.27, code: 'UK' }, 
                { name: 'Francia', weight: 3.89, code: 'FRA' }, 
                { name: 'Germania', weight: 3.53, code: 'DEU' }, 
                { name: 'Australia', weight: 3.27, code: 'AUS' }, 
                { name: 'Svizzera', weight: 3.09, code: 'SWI' }, 
                { name: 'Svezia', weight: 2.80, code: 'SWE' }, 
                { name: 'Paesi Bassi', weight: 2.04, code: 'NLD' }
            ],
            'EWEQ': [ // NUOVO AGGIUNTO
                { name: 'Regno Unito', weight: 12.0, code: 'UK' }, 
                { name: 'Francia', weight: 11.0, code: 'FRA' }, 
                { name: 'Germania', weight: 10.0, code: 'DEU' }, 
                { name: 'Svizzera', weight: 8.0, code: 'SWI' }, 
                { name: 'Paesi Bassi', weight: 7.0, code: 'NLD' }, 
                { name: 'Spagna', weight: 6.0, code: 'SPA' }, 
                { name: 'Italia', weight: 5.0, code: 'ITA' }, 
                { name: 'Svezia', weight: 4.0, code: 'SWE' }, 
                { name: 'Danimarca', weight: 3.0, code: 'DEN' }, 
                { name: 'Belgio', weight: 2.5, code: 'BEL' }
            ],
            'CSSPX': [
                { name: 'Stati Uniti (USA)', weight: 99.8, code: 'USA' },
                { name: 'Irlanda', weight: 0.2, code: 'IRL' } 
            ],
            'SWDA': [
                { name: 'Stati Uniti (USA)', weight: 69.5, code: 'USA' },
                { name: 'Giappone', weight: 6.0, code: 'JPN' },
                { name: 'Regno Unito', weight: 3.8, code: 'UK' },
                { name: 'Canada', weight: 3.0, code: 'CAN' },
                { name: 'Francia', weight: 2.9, code: 'FRA' },
                { name: 'Svizzera', weight: 2.5, code: 'SWI' },
                { name: 'Germania', weight: 2.2, code: 'DEU' },
                { name: 'Australia', weight: 1.8, code: 'AUS' },
                { name: 'Paesi Bassi', weight: 1.4, code: 'NLD' },
                { name: 'Svezia', weight: 1.0, code: 'SWE' }
            ],
            'CSEMU': [
                { name: 'Francia', weight: 32.0, code: 'FRA' },
                { name: 'Germania', weight: 26.0, code: 'DEU' },
                { name: 'Paesi Bassi', weight: 13.0, code: 'NLD' },
                { name: 'Irlanda', weight: 7.0, code: 'IRL' },
                { name: 'Spagna', weight: 6.0, code: 'SPA' },
                { name: 'Italia', weight: 5.0, code: 'ITA' },
                { name: 'Belgio', weight: 3.0, code: 'BEL' },
                { name: 'Finlandia', weight: 2.0, code: 'FIN' },
                { name: 'Austria', weight: 1.0, code: 'AUT' },
                { name: 'Portogallo', weight: 0.5, code: 'POR' }
            ]
        };
        
        const ETF_HOLDINGS_DETAIL = { 
            'VWCE': [
                { name: 'NVIDIA Corp', ticker: 'NVDA', weight: 4.98 },
                { name: 'Apple Inc', ticker: 'AAPL', weight: 4.14 },
                { name: 'Microsoft Corp', ticker: 'MSFT', weight: 4.04 },
                { name: 'Alphabet Inc (Cl A/C)', ticker: 'GOOGL/GOOG', weight: 3.12 }, 
                { name: 'Amazon.com Inc', ticker: 'AMZN', weight: 2.46 },
                { name: 'Broadcom Inc', ticker: 'AVGO', weight: 1.80 },
                { name: 'Meta Platforms Inc', ticker: 'META', weight: 1.49 },
                { name: 'Tesla Inc', ticker: 'TSLA', weight: 1.35 },
                { name: 'Taiwan Semi. Manufac.', ticker: 'TSM', weight: 1.25 },
                { name: 'Berkshire Hathaway Inc (B)', ticker: 'BRK.B', weight: 1.15 }
            ], 
            'EXUS': [
                { name: 'ASML Holding NV', ticker: 'ASML', weight: 1.84 },
                { name: 'Novo Nordisk A/S (B)', ticker: 'NN', weight: 1.70 }, 
                { name: 'Roche Holding AG', ticker: 'ROG', weight: 1.40 }, 
                { name: 'Nestle SA', ticker: 'NESN', weight: 1.30 }, 
                { name: 'ASTRAZENECA PLC', ticker: 'AZ', weight: 1.26 }, 
                { name: 'Novartis AG', ticker: 'NOVN', weight: 1.20 }, 
                { name: 'Toyota Motor Corp', ticker: 'TM', weight: 1.10 }, 
                { name: 'LVMH Moet Hennessy', ticker: 'LVMH', weight: 0.95 },
                { name: 'Samsung Electronic Co Ltd (GDR)', ticker: 'SAMS.GDR', weight: 0.85 },
                { name: 'Royal Bank of Canada', ticker: 'RY', weight: 0.70 }
            ],
            'SMEA': [
                { name: 'Novo Nordisk A/S (B)', ticker: 'NN', weight: 3.76 }, 
                { name: 'ASML Holding NV', ticker: 'ASML', weight: 3.07 },
                { name: 'ASTRAZENECA PLC', ticker: 'AZ', weight: 2.19 },
                { name: 'LVMH Moet Hennessy', ticker: 'LVMH', weight: 2.15 },
                { name: 'Nestle SA', ticker: 'NESN', weight: 1.95 }, 
                { name: 'SAP SE', ticker: 'SAP', weight: 1.93 },
                { name: 'Novartis AG', ticker: 'NOVN', weight: 1.89 }, 
                { name: 'TotalEnergies SE', ticker: 'TTE', weight: 1.67 },
                { name: 'Shell PLC', ticker: 'SHEL', weight: 1.63 },
                { name: 'Roche Holding AG', ticker: 'ROG', weight: 1.60 }
            ],
            'AEME': [ 
                { name: 'Taiwan Semi. Manufac.', ticker: 'TSM', weight: 11.27 }, 
                { name: 'Tencent Holdings Ltd', ticker: 'TENCENT', weight: 5.08 }, 
                { name: 'Alibaba Group Holding Ltd', ticker: 'ALIBABA', weight: 3.40 }, 
                { name: 'Samsung Electronic Co Ltd', ticker: 'SAMS', weight: 3.31 }, 
                { name: 'SK Hynix Inc', ticker: 'SKHYNIX', weight: 1.94 }, 
                { name: 'HDFC Bank Limited', ticker: 'HDFC', weight: 1.27 }, 
                { name: 'Reliance Industries Limited', ticker: 'RELIANCE', weight: 1.07 },
                { name: 'China Construction Bank HK', ticker: 'CCB', weight: 1.01 },
                { name: 'Hon Hai Precision Industry', ticker: 'HONHAI', weight: 0.91 },
                { name: 'Xiaomi Corp', ticker: 'XIAOMI', weight: 0.88 }
            ],
            'MWEQ': [ 
                { name: 'Johnson & Johnson', ticker: 'JNJ', weight: 0.15 },
                { name: 'Exxon Mobil Corp', ticker: 'XOM', weight: 0.15 },
                { name: 'Broadcom Inc', ticker: 'AVGO', weight: 0.15 },
                { name: 'Home Depot Inc', ticker: 'HD', weight: 0.15 },
                { name: 'Chevron Corp', ticker: 'CVX', weight: 0.15 },
                { name: 'Merck & Co. Inc.', ticker: 'MRK', weight: 0.15 },
                { name: 'Royal Bank of Canada', ticker: 'RY', weight: 0.15 },
                { name: 'Toyota Motor Corp', ticker: 'TM', weight: 0.15 },
                { name: 'Shell PLC', ticker: 'SHEL', weight: 0.15 },
                { name: 'Novo Nordisk A/S (B)', ticker: 'NN', weight: 0.15 }
            ],
            'EWEQ': [ // NUOVO AGGIUNTO
                { name: 'Shell PLC', ticker: 'SHEL', weight: 0.5 },
                { name: 'Novartis AG', ticker: 'NOVN', weight: 0.5 },
                { name: 'TotalEnergies SE', ticker: 'TTE', weight: 0.4 },
                { name: 'Novo Nordisk A/S (B)', ticker: 'NN', weight: 0.4 },
                { name: 'ASTRAZENECA PLC', ticker: 'AZ', weight: 0.4 },
                { name: 'SAP SE', ticker: 'SAP', weight: 0.4 },
                { name: 'LVMH Moet Hennessy', ticker: 'LVMH', weight: 0.4 },
                { name: 'ASML Holding NV', ticker: 'ASML', weight: 0.4 },
                { name: 'BP PLC', ticker: 'BP', weight: 0.3 },
                { name: 'Siemens AG', ticker: 'SIE', weight: 0.3 }
            ],
            'CSSPX': [
                { name: 'NVIDIA Corp', ticker: 'NVDA', weight: 7.59 },
                { name: 'Apple Inc', ticker: 'AAPL', weight: 7.28 },
                { name: 'Microsoft Corp', ticker: 'MSFT', weight: 6.24 },
                { name: 'Amazon.com Inc', ticker: 'AMZN', weight: 3.90 },
                { name: 'Alphabet Inc (Cl A)', ticker: 'GOOGL', weight: 3.15 },
                { name: 'Broadcom Inc', ticker: 'AVGO', weight: 3.07 },
                { name: 'Alphabet Inc (Cl C)', ticker: 'GOOG', weight: 2.53 },
                { name: 'Meta Platforms Inc', ticker: 'META', weight: 2.40 },
                { name: 'Tesla Inc', ticker: 'TSLA', weight: 2.06 },
                { name: 'Berkshire Hathaway Inc (B)', ticker: 'BRK.B', weight: 1.59 }
            ],
            'SWDA': [
                { name: 'NVIDIA Corp', ticker: 'NVDA', weight: 5.30 },
                { name: 'Apple Inc', ticker: 'AAPL', weight: 4.80 },
                { name: 'Microsoft Corp', ticker: 'MSFT', weight: 4.70 },
                { name: 'Alphabet Inc (Cl A/C)', ticker: 'GOOGL/GOOG', weight: 3.50 }, 
                { name: 'Amazon.com Inc', ticker: 'AMZN', weight: 2.80 },
                { name: 'Broadcom Inc', ticker: 'AVGO', weight: 2.00 },
                { name: 'Meta Platforms Inc', ticker: 'META', weight: 1.65 },
                { name: 'Tesla Inc', ticker: 'TSLA', weight: 1.50 },
                { name: 'Eli Lilly and Co', ticker: 'LLY', weight: 1.30 },
                { name: 'Taiwan Semi. Manufac.', ticker: 'TSM', weight: 1.20 }
            ],
            'CSEMU': [
                { name: 'ASML Holding NV', ticker: 'ASML', weight: 5.94 },
                { name: 'SAP SE', ticker: 'SAP', weight: 3.54 },
                { name: 'Siemens AG', ticker: 'SIE', weight: 2.81 },
                { name: 'LVMH Moet Hennessy', ticker: 'LVMH', weight: 2.59 },
                { name: 'Allianz SE', ticker: 'ALV', weight: 2.34 },
                { name: 'Banco Santander SA', ticker: 'SAN', weight: 2.30 },
                { name: 'Schneider Electric SE', ticker: 'SE', weight: 2.06 },
                { name: 'Iberdrola SA', ticker: 'IBE', weight: 1.88 },
                { name: 'Airbus SE', ticker: 'AIR', weight: 1.84 },
                { name: 'TotalEnergies SE', ticker: 'TTE', weight: 1.83 }
            ]
        };


        // --- LOGICA MODALE (OMESSA PER BREVITÀ, RIMANE INVARIATA) ---
        function showEtfDetailsModal(etfId) {
            const info = ETF_INFO_DETAIL[etfId];
            const countries = ETF_COUNTRY_DETAIL[etfId];
            const holdings = ETF_HOLDINGS_DETAIL[etfId];

            if (!info) return;

            document.getElementById('modalIndexName').textContent = info.index;
            document.getElementById('modalIndexPurpose').textContent = info.purpose;

            const modalCountryBody = document.getElementById('modalCountryBody');
            modalCountryBody.innerHTML = '';
            
            if (countries && countries.length > 0) {
                countries.slice(0, 10).forEach((item, index) => {
                    const row = modalCountryBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td class="text-end">${item.weight.toFixed(2)}%</td>
                    `;
                });
            } else {
                 modalCountryBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Dati non disponibili.</td></tr>';
            }

            const modalHoldingsBody = document.getElementById('modalHoldingsBody');
            modalHoldingsBody.innerHTML = '';
            
            if (holdings && holdings.length > 0) {
                 holdings.slice(0, 10).forEach((item, index) => {
                    const row = modalHoldingsBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.name} <small class="text-muted">(${item.ticker})</small></td>
                        <td class="text-end">${item.weight.toFixed(2)}%</td>
                    `;
                });
            } else {
                 modalHoldingsBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Dati non disponibili.</td></tr>';
            }


            const myModal = new bootstrap.Modal(document.getElementById('etfDetailModal'));
            myModal.show();
        }

        // Funzione generica per aggregare i dati (tracciamento colori)
        function aggregateAndDisplayTopTen(etfWeights, detailMap, tableBodyId, totalRefId, keyType) {
            let aggregatedData = {};
            let totalEtfAllocation = Object.values(etfWeights).reduce((sum, current) => sum + current, 0);

            for (const [etfId, etfPercentage] of Object.entries(etfWeights)) {
                if (etfPercentage > 0 && detailMap[etfId]) {
                    const contributionFactor = etfPercentage / 100;

                    detailMap[etfId].forEach(item => {
                        const key = item.name; 
                        const weightedContribution = item.weight * contributionFactor;

                        if (!aggregatedData[key]) {
                            aggregatedData[key] = {
                                name: item.name,
                                ticker: item.ticker || '', 
                                weighted_percentage: 0,
                                etfs: new Set() 
                            };
                        }

                        aggregatedData[key].weighted_percentage += weightedContribution;
                        aggregatedData[key].etfs.add(etfId); 
                    });
                }
            }

            let sortedData = Object.values(aggregatedData)
                .sort((a, b) => b.weighted_percentage - a.weighted_percentage);

            const top10Data = sortedData.slice(0, 10);
            const top10Total = top10Data.reduce((sum, item) => sum + item.weighted_percentage, 0);

            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';

            if (totalEtfAllocation < 0.01) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Seleziona e assegna una percentuale a uno o più Indici.</td></tr>';
            } else if (top10Data.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Dati Top 10 non disponibili.</td></tr>';
            } else {
                let rank = 1;
                top10Data.forEach(item => {
                    const row = tableBody.insertRow();
                    
                    const etfDotsHtml = Array.from(item.etfs).map(etfId => {
                        const indexName = ETF_INFO_DETAIL[etfId] ? ETF_INFO_DETAIL[etfId].index : etfId;
                        const bgClass = ETF_COLOR_MAP[etfId] ? ETF_COLOR_MAP[etfId].split(' ')[0] : 'bg-secondary';
                        return `<span class="badge-dot ${bgClass} me-1" title="${indexName}"></span>`;
                    }).join('');
                    
                    row.innerHTML = `
                        <th scope="row">${rank++}</th>
                        <td class="${keyType === 'holding' ? 'holding-name' : ''}">${item.name}</td>
                        <td class="text-end">${item.weighted_percentage.toFixed(2)}%</td>
                        <td>${etfDotsHtml}</td>
                    `;
                });
            }

            document.getElementById(totalRefId).textContent = top10Total.toFixed(2) + '%';
        }

        function recalculateHoldingsExposure(etfWeights) {
            aggregateAndDisplayTopTen(etfWeights, ETF_HOLDINGS_DETAIL, 'holdingsTableBody', 'holdingsTotalRef', 'holding');
        }

        function recalculateCountryExposure(etfWeights) {
            aggregateAndDisplayTopTen(etfWeights, ETF_COUNTRY_DETAIL, 'countryTableBody', 'countryTotalRef', 'country');
        }


        // Funzione per il calcolo dell'esposizione geografica (continenti)
        function recalculateGeoExposure(etfWeights) {
            let geoExposure = { 'NA': 0, 'EU': 0, 'PA': 0, 'EM': 0 };
            let totalGeo = 0;
            const geoChartLabels = [];
            const geoChartData = [];
            const geoChartColors = [];
            let totalEtfAllocation = Object.values(etfWeights).reduce((sum, current) => sum + current, 0);

            for (const [etfId, etfPercentage] of Object.entries(etfWeights)) {
                if (etfPercentage > 0) {
                    const factor = etfPercentage / 100;
                    const geoData = ETF_GEO_DISTRIBUTION[etfId];

                    for (const regionCode in geoData) {
                        if (geoData.hasOwnProperty(regionCode)) {
                            geoExposure[regionCode] += geoData[regionCode] * factor;
                        }
                    }
                }
            }
            
            for (const regionCode in geoExposure) {
                totalGeo += geoExposure[regionCode];
            }

            const geoTableBody = document.getElementById('geoTableBody');
            geoTableBody.innerHTML = '';
            
            let chartColorIndex = 0;
            const regionOrder = ['NA', 'EU', 'PA', 'EM']; 

            if (totalEtfAllocation < 0.01) {
                geoTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Seleziona e assegna una percentuale a uno o più Indici.</td></tr>';
            } else {
                regionOrder.forEach(regionCode => {
                    if (geoExposure[regionCode] > 0.01) {
                        const percentage = geoExposure[regionCode];
                        const row = geoTableBody.insertRow();
                        row.innerHTML = `
                            <td><span class="badge-dot" style="background-color: ${geoColors[chartColorIndex]}"></span> ${REGION_NAMES[regionCode]}</td>
                            <td class="text-end">${percentage.toFixed(2)}%</td>
                        `;
                        
                        geoChartLabels.push(REGION_NAMES[regionCode]);
                        geoChartData.push(percentage.toFixed(2));
                        geoChartColors.push(geoColors[chartColorIndex]);
                        
                        chartColorIndex++;
                    }
                });
            }


            document.getElementById('geoTotal').textContent = totalGeo.toFixed(2) + '%';

            if (geoChartLabels.length > 0) {
                createDoughnutChart('geoChart', geoChartLabels, geoChartData, geoChartColors);
            } else {
                 if (geoChartInstance) {
                     geoChartInstance.destroy();
                     geoChartInstance = null;
                 }
                 const ctx = document.getElementById('geoChart').getContext('2d');
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            }
        }


        // ----------------------------------------------------------------------
        // --- NUOVA LOGICA SOLVER (RICERCA EQUALLY WEIGHTED A LIVELLO PAESE) ---
        // ----------------------------------------------------------------------

        // Helper: Aggrega i pesi dei paesi per il calcolo della varianza
        function aggregateCountryWeightsForSolver(etfWeights) {
            let aggregatedData = {};
            for (const [etfId, etfPercentage] of Object.entries(etfWeights)) {
                if (etfPercentage > 0 && ETF_COUNTRY_DETAIL[etfId]) {
                    const contributionFactor = etfPercentage / 100;
                    ETF_COUNTRY_DETAIL[etfId].forEach(item => {
                        const key = item.name;
                        const weightedContribution = item.weight * contributionFactor;
                        aggregatedData[key] = (aggregatedData[key] || 0) + weightedContribution;
                    });
                }
            }
            return aggregatedData;
        }

        // Helper: Calcola la varianza dei pesi dei paesi aggregati
        function calculateCountryVariance(countryWeights) {
            // Considera solo i paesi con un peso > 0.1% per l'ottimizzazione
            const weights = Object.values(countryWeights).filter(w => w > 0.1); 
            if (weights.length < 2) return Infinity; // Serve almeno due paesi per calcolare la varianza

            // Calcola la media dei pesi tra i paesi considerati
            const mean = weights.reduce((sum, w) => sum + w, 0) / weights.length;
            // Calcola la varianza (misura della dispersione rispetto alla media)
            const variance = weights.reduce((sum, w) => sum + Math.pow(w - mean, 2), 0) / weights.length;
            return variance;
        }

        // Funzione principale di ottimizzazione (Solver Equally Weighted Paesi)
        function findEqualWeightAllocation() {
            // Usiamo i 4 indici più "puri" per bilanciare NA, EU, EM, e Resto del Mondo
            const solverEtfs = ['CSSPX', 'SMEA', 'AEME', 'EXUS']; 
            const step = 5; // Pesi in passi del 5% (0, 5, 10, ..., 100)
            const maxTotal = 100; // Il target è esattamente 100%

            let bestWeights = {};
            let minVariance = Infinity;
            let bestTotalWeight = 0;

            // Inizializzazione di tutti i pesi a 0 
            const etfWeightsBase = {};
            document.querySelectorAll('.etf-percentage-input').forEach(input => {
                etfWeightsBase[input.getAttribute('data-etf-id')] = 0;
            });
            
            // Grid Search: Prova tutte le combinazioni possibili (a passi di 5%)
            // L'ottimizzazione è mirata a trovare l'allocazione che minimizza la varianza dei pesi tra i paesi, mantenendo il totale a 100%.
            
            for (let w0 = 0; w0 <= maxTotal; w0 += step) { // CSSPX (USA)
                for (let w1 = 0; w1 <= maxTotal - w0; w1 += step) { // SMEA (Europe Developed)
                    for (let w2 = 0; w2 <= maxTotal - w0 - w1; w2 += step) { // AEME (Emerging Markets)
                        
                        // w3 (EXUS - World Ex USA Developed) è forzato a coprire la parte rimanente per arrivare al 100%
                        const w3 = maxTotal - w0 - w1 - w2; 
                        
                        // w3 è garantito >= 0. Il totale è garantito a 100.
                        const currentTotalWeight = 100; 

                        const currentEtfWeights = { ...etfWeightsBase };
                        currentEtfWeights['CSSPX'] = w0;
                        currentEtfWeights['SMEA'] = w1;
                        currentEtfWeights['AEME'] = w2;
                        currentEtfWeights['EXUS'] = w3;
                        
                        // 1. Calcola l'esposizione per paese
                        const countryExposure = aggregateCountryWeightsForSolver(currentEtfWeights);
                        
                        // 2. Calcola la varianza tra i pesi dei paesi
                        const variance = calculateCountryVariance(countryExposure);

                        // 3. Aggiorna il miglior risultato (varianza minima)
                        if (variance < minVariance) {
                            minVariance = variance;
                            bestWeights = { ...currentEtfWeights };
                            bestTotalWeight = currentTotalWeight;
                        }
                    }
                }
            }
            
            // Applica i pesi migliori ai campi input
            if (bestTotalWeight === 100 && minVariance !== Infinity) {
                document.querySelectorAll('.etf-percentage-input').forEach(input => {
                    const etfId = input.getAttribute('data-etf-id');
                    // Applica il peso trovato o 0
                    input.value = bestWeights[etfId] || 0; 
                });
                // Ricalcola e aggiorna la dashboard con i nuovi pesi
                recalculateEtfDetail();
                alert(`Allocazione bilanciata a livello di paese trovata con peso totale del ${bestTotalWeight}% e varianza minima (Varianza: ${minVariance.toFixed(4)}). I nuovi pesi sono stati inseriti.
                Dettagli: CSSPX (${bestWeights['CSSPX'] || 0}%), SMEA (${bestWeights['SMEA'] || 0}%), AEME (${bestWeights['AEME'] || 0}%), EXUS (${bestWeights['EXUS'] || 0}%)`);

            } else {
                 alert('Impossibile trovare una soluzione equally weighted valida che raggiunga il 100% di allocazione.');
            }
        }


        // --- LOGICA PRINCIPALE E INIZIALIZZAZIONE ---
        
        const etfInputs = document.querySelectorAll('.etf-percentage-input');
        const totalEtfPercentageCell = document.getElementById('totalEtfPercentage');
        
        function recalculateEtfDetail() {
            let totalPercentage = 0;
            let etfWeights = {}; 

            etfInputs.forEach(input => {
                let percentage = parseFloat(input.value) || 0;
                const etfId = input.getAttribute('data-etf-id'); 
                
                if (percentage > 100) { 
                    input.value = 100;
                    percentage = 100; 
                } 
                
                totalPercentage += percentage;
                etfWeights[etfId] = percentage;
            });

            let totalDisplay = totalPercentage.toFixed(1) + '%';
            
            // Segnala in rosso se la somma non è 100.0%
            if (Math.abs(totalPercentage - 100) > 0.01 && totalPercentage > 0.01) { 
                totalEtfPercentageCell.classList.add('text-danger');
            } else {
                totalEtfPercentageCell.classList.remove('text-danger');
            }
            totalEtfPercentageCell.textContent = totalDisplay;
            
            recalculateGeoExposure(etfWeights);
            recalculateHoldingsExposure(etfWeights);
            recalculateCountryExposure(etfWeights); 
        }

        function resetEtfPercentages() {
            etfInputs.forEach(input => {
                input.value = '0'; 
            });
            recalculateEtfDetail(); 
        }

        function initializeChartsAndListeners() {
            
            recalculateEtfDetail();

            etfInputs.forEach(input => {
                input.addEventListener('input', recalculateEtfDetail);
                input.addEventListener('change', recalculateEtfDetail); 
            });
            
            const resetButton = document.getElementById('resetEtfButton');
            if (resetButton) {
                resetButton.addEventListener('click', resetEtfPercentages);
            }
            
            // LISTENER PER IL NUOVO PULSANTE EQUALLY WEIGHTED
            const equalWeightButton = document.getElementById('calculateEqualWeightButton');
            if (equalWeightButton) {
                equalWeightButton.addEventListener('click', findEqualWeightAllocation);
            }
            
            const etfInfoLinks = document.querySelectorAll('.etf-info-link');
            etfInfoLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault(); 
                    const etfId = this.getAttribute('data-etf-id');
                    showEtfDetailsModal(etfId);
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', initializeChartsAndListeners);
        
    </script>
</body>
</html>
