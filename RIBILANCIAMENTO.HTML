<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool di Ribilanciamento ETF (Dinamico e Stabile)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Stili riutilizzati dalla dashboard precedente */
        .table-footer-total {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .highlight-input {
            background-color: #fff3cd;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: right;
        }
        .calculated-value {
            font-weight: bold;
            text-align: right;
        }
        .card-header-rebalance {
            background-color: #198754;
            color: white;
        }
        .disclaimer {
            font-size: 0.85rem;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
        }

        /* MODIFICHE PER STABILITÀ E RESPONSIVE */
        
        /* SOLUZIONE 1: Contenitore con altezza fissa per l'alert */
        #validationAlertContainer {
            height: 70px; /* Altezza fissa per l'alert + margine */
            margin-bottom: 0 !important; /* Rimuove il margine standard */
            padding-bottom: 10px; /* Aggiunge un po' di spazio prima della card body */
        }
        .percent-cell {
            white-space: nowrap;
            text-align: right;
        }
        /* SOLUZIONE 2: Larghezza e padding ottimizzati per l'input numerico */
        .percent-input {
            width: 55px; /* Leggermente aumentata per accogliere 3 cifre */
            max-width: 100%;
            text-align: right;
            border: 1px solid #ced4da;
            padding: 0.375rem 0.2rem; /* Ridotto il padding laterale per dare più spazio al valore */
            display: inline-block;
        }

        /* Manteniamo le larghezze delle colonne per il layout desktop/tablet */
        .table-responsive table {
            table-layout: fixed;
            width: 100%;
        }
        .col-etf { width: 15%; }
        .col-index { width: 40%; }
        .col-percent { width: 20%; }
        .col-capitale { width: 25%; }
        
    </style>
</head>
<body class="bg-light">

    <div class="container py-5">
        
        <header class="mb-5 text-center">
            <h1 class="display-5 fw-bold text-success">Strumento di Ribilanciamento Dinamico</h1>
            <p class="lead text-secondary">Inserisci il capitale e modifica le percentuali target per simulare la tua allocazione.</p>
        </header>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <div id="validationAlertContainer"> 
                    <div id="validationAlert" class="alert alert-warning d-none" role="alert">
                        ⚠️ **ATTENZIONE:** La somma delle percentuali è pari a <span id="currentTotalPercent"></span>%. Deve essere esattamente **100%** per un'allocazione corretta.
                    </div>
                </div>

                <div class="card shadow-lg h-100">
                    <div class="card-header card-header-rebalance">
                        <h4 class="mb-0 fs-5">Allocazione del Capitale sugli ETF/ETC</h4>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-4">
                            <label for="capitaleInvestito" class="form-label fs-5 fw-bold text-primary">CAPITALE TOTALE DA INVESTIRE (€)</label>
                            <input type="number" 
                                   class="form-control highlight-input" 
                                   id="capitaleInvestito" 
                                   placeholder="Es. 21000" 
                                   value="21000" 
                                   min="0"
                                   step="1">
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col" class="col-etf">ETF/ETC</th>
                                        <th scope="col" class="col-index">Indice</th>
                                        <th scope="col" class="text-end col-percent">Percentuale Target (%)</th>
                                        <th scope="col" class="text-end col-capitale">Allocazione Capitale (€)</th>
                                    </tr>
                                </thead>
                                <tbody id="allocationTableBody">
                                    </tbody>
                                <tfoot class="table-footer-total">
                                    <tr>
                                        <td colspan="2">SOMMA PERCENTUALE / TOTALE CAPITALE</td>
                                        <td class="text-end" id="totalPercentFooter">100%</td>
                                        <td class="text-end" id="totalAllocated">€ 0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="container py-4">
        <div class="disclaimer text-center">
            <p class="fw-bold text-danger">⚠️ IMPORTANTE: DISCLAIMER LEGALE</p>
            <p>Questo strumento di calcolo ha **esclusivamente scopo informativo e didattico**. I calcoli si basano sulle percentuali target definite e non tengono conto di costi di transazione, tassazione o quotazioni di mercato in tempo reale.</p>
            <p class="mb-0">**Queste informazioni non costituiscono in alcun modo consulenza finanziaria personalizzata.**</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Dati iniziali (percentuali Target 50/40/5/5)
        let etfData = [
            { ticker: 'VWCE', index: 'FTSE All World', percentage: 50 },
            { ticker: 'EXUS', index: 'MSCI World Ex USA', percentage: 40 },
            { ticker: 'SMEA', index: 'MSCI Europe', percentage: 5 },
            { ticker: 'AEME', index: 'MSCI EM', percentage: 5 }
        ];

        const inputCapitale = document.getElementById('capitaleInvestito');
        const tableBody = document.getElementById('allocationTableBody');
        const totalAllocatedDisplay = document.getElementById('totalAllocated');
        const totalPercentFooter = document.getElementById('totalPercentFooter');
        const validationAlert = document.getElementById('validationAlert');
        const currentTotalPercent = document.getElementById('currentTotalPercent');

        /**
         * Popola la tabella con i campi di input per le percentuali
         */
        function populateTable() {
            let htmlContent = '';
            etfData.forEach((item, index) => {
                htmlContent += `
                    <tr>
                        <td><span class="badge bg-dark">${item.ticker}</span></td>
                        <td>${item.index}</td>
                        <td class="percent-cell">
                            <input type="number" 
                                   class="percent-input" 
                                   data-index="${index}"
                                   value="${item.percentage}"
                                   min="0"
                                   max="100"
                                   step="1">
                            %
                        </td>
                        <td class="calculated-value text-success" id="capitale-${index}">€ 0.00</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = htmlContent;

            // Aggiunge l'event listener a tutti i nuovi input di percentuale
            document.querySelectorAll('.percent-input').forEach(input => {
                input.addEventListener('input', updatePercentage);
                input.addEventListener('change', enforceInteger);
            });
        }
        
        /**
         * Assicura che l'input sia un numero intero (necessario per il vincolo)
         */
        function enforceInteger(event) {
             const value = parseFloat(event.target.value);
             if (value % 1 !== 0) {
                 event.target.value = Math.round(value);
                 // Richiama l'aggiornamento dopo aver forzato l'intero
                 updatePercentage(event); 
             }
        }
        
        /**
         * Aggiorna l'array dei dati quando un campo percentuale viene modificato
         */
        function updatePercentage(event) {
            const index = parseInt(event.target.getAttribute('data-index'));
            let value = parseInt(event.target.value) || 0;
            
            // Limita il valore tra 0 e 100
            if (value < 0) value = 0;
            if (value > 100) value = 100;
            event.target.value = value;
            
            etfData[index].percentage = value;
            calculateAndRender();
        }

        /**
         * Funzione principale per il calcolo e l'aggiornamento dei risultati
         */
        function calculateAndRender() {
            const totalCapital = parseFloat(inputCapitale.value) || 0;
            let totalAllocated = 0;
            let currentTotalPercentValue = 0;

            etfData.forEach((item, index) => {
                // Calcolo dell'allocazione (percentuale divisa per 100)
                const allocationRatio = item.percentage / 100;
                const allocatedCapital = totalCapital * allocationRatio;
                
                totalAllocated += allocatedCapital;
                currentTotalPercentValue += item.percentage;

                // Aggiorna il campo Capitale Allocato nella riga
                document.getElementById(`capitale-${index}`).textContent = `€ ${allocatedCapital.toFixed(2)}`;
            });

            // --- VALIDAZIONE E AGGIORNAMENTO FOOTER ---

            // Aggiorna il totale allocato nel footer
            totalAllocatedDisplay.textContent = `€ ${totalAllocated.toFixed(2)}`;
            totalPercentFooter.textContent = `${currentTotalPercentValue}%`;

            // Validazione del 100%
            if (currentTotalPercentValue !== 100) {
                validationAlert.classList.remove('d-none');
                currentTotalPercent.textContent = currentTotalPercentValue;
                totalPercentFooter.classList.add('text-danger');
                totalAllocatedDisplay.classList.add('text-danger');
            } else {
                validationAlert.classList.add('d-none');
                totalPercentFooter.classList.remove('text-danger');
                totalAllocatedDisplay.classList.remove('text-danger');
            }
        }

        // --- Event Listeners e Inizializzazione ---
        
        inputCapitale.addEventListener('input', calculateAndRender);

        // Esegue la popolazione e il calcolo iniziale al caricamento della pagina
        document.addEventListener('DOMContentLoaded', () => {
            populateTable();
            calculateAndRender();
        });
        
    </script>
</body>
</html>